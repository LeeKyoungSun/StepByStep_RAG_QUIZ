# app/rag/prompts/prompts.py
"""
청소년 성교육 퀴즈 생성 프롬프트 (개선판)
- 정답 위치 랜덤화
- 해설 필수 포함
- 다양한 질문 형식
"""

SITUATION_PROMPT = """당신은 청소년 성교육 전문가입니다.
14-19세 학습자를 위한 **교육적 상황 문제**를 만드세요.

**중요: 부적절한 상황 금지**
- "오늘 저녁 성관계 예정" 같은 직접적 표현 금지
- 성행위 직전 상황 금지
- 압박적이거나 불편한 관계 묘사 금지

**적절한 상황 예시**
- 보건 수업/강연 후 정보 확인
- 약국/편의점에서 제품 구매 상황
- 친구/선배와 대화 중 잘못된 정보 접함
- SNS/온라인에서 본 내용에 대한 의문
- 보건실 상담/질문 준비

**문제 구성**
질문: [배경 상황] + [구체적 고민/선택지] + "어떻게 해야 할까?" 또는 "가장 적절한 행동은?"

보기 4개 (각 2-3문장):
- 1개는 안전하고 정확한 행동 + 명시적 이유/근거 (정답)
- 1개는 불완전한 행동 (중요 조건 누락)
- 1개는 흔한 오해에 기반한 행동
- 1개는 위험하거나 부적절한 행동

**중요: 정답 위치**
- 정답은 A, B, C, D 중 **랜덤한 위치**에 배치하세요
- 매번 A가 정답이 되지 않도록 주의하세요

**키워드**: {keyword}
**주제**: {topic}
**정답 위치**: {correct_position} 번째 선택지가 정답이어야 합니다

[근거 자료]
{context}

**정답 작성 시 필수 규칙**
1. 행동 + 이유를 모두 포함
2. "때문에", "이므로", "하므로", "따라서" 등 인과관계 표현 사용
3. 최소 60자 이상 작성
4. 예시: "포장을 확인하고 유통기한을 꼼꼼히 본다. 손상된 제품은 피임 효과가 떨어질 수 있으므로 새 제품으로 교체를 요청한다."

**해설 작성 필수**
- 정답이 왜 옳은지 명확하게 설명
- 다른 선택지가 왜 틀렸는지 간단히 설명
- 2-4문장으로 작성
- 교육적 가치가 있어야 함

**출력 예시**
{{
  "question": "보건 수업에서 피임 방법을 배웠어. 방과 후 약국에서 콘돔을 사려는데 포장이 찢어진 제품이 보여. 가장 적절한 행동은?",
  "choices": [
    "약간 찢어진 정도는 괜찮다고 생각하고 그냥 구매한다.",
    "포장 상태와 유통기한을 꼼꼼히 확인한다. 손상된 제품은 효과가 떨어질 수 있으므로 직원에게 교체를 요청한다.",
    "가격이 저렴하면 상태와 관계없이 구매한다.",
    "포장은 확인하지만 유통기한은 크게 중요하지 않다고 생각한다."
  ],
  "correct_index": 1,
  "explanation": "포장이 손상된 피임 도구는 제품의 무결성이 보장되지 않아 효과가 크게 떨어질 수 있습니다. 유통기한과 포장 상태를 반드시 확인하고, 문제가 있다면 교체를 요청하는 것이 안전합니다. 가격보다 안전성이 우선되어야 합니다."
}}

**필수 규칙**
1. [근거 자료]의 내용만 사용
2. 정답은 반드시 {correct_position} 번째 위치에 배치
3. 각 보기는 완전한 문장으로 작성
4. 정답에는 "행동 + 이유" 포함
5. 해설은 필수이며 교육적이어야 함
6. JSON 형식으로만 출력

JSON만 출력하세요:"""

CONCEPT_PROMPT = """당신은 청소년 성교육 전문가입니다.
14-19세 학습자를 위한 **개념 이해 문제**를 만드세요.

**문제 유형 (다양하게 활용)**
- "~의 설명으로 **옳은** 것은?"
- "~의 특징으로 **틀린** 것은?"
- "~의 사용법으로 **적절한** 것은?"
- "~에 대한 설명 중 **올바른** 것은?"
- "~의 효과로 **부적절한** 것은?"

**질문 형식 예시**
- "다음 중 콘돔의 사용법으로 올바른 것은?"
- "매독의 증상에 대한 설명으로 틀린 것은?"
- "경구 피임약의 특징으로 적절하지 않은 것은?"
- "IUD에 대한 설명 중 옳은 것은?"

**문제 구성**
질문: 명확하고 구체적인 개념 질문

보기 4개 (각 2-3문장):
- 1개는 정확한 설명 + 핵심 특징/수치 (정답 또는 오답 - 질문 형식에 따라)
- 1개는 부분만 맞는 설명 (조건 누락)
- 1개는 흔한 오해나 다른 개념과 혼동
- 1개는 완전히 잘못된 설명

**중요: 정답 위치**
- 정답은 A, B, C, D 중 **랜덤한 위치**에 배치하세요
- 매번 A가 정답이 되지 않도록 주의하세요

**키워드**: {keyword}
**주제**: {topic}
**질문 형식**: {question_type}
**정답 위치**: {correct_position} 번째 선택지가 정답이어야 합니다

[근거 자료]
{context}

**정답 작성 시 필수 규칙**
1. 정의 + 핵심 특징 + 수치/기간 포함
2. "이는 ~이므로", "~때문에", "~하는 특징이 있다" 등 설명적 표현
3. 최소 60자 이상 작성
4. 예시: "임플란트는 팔 안쪽 피부 아래 삽입하는 작은 막대형 피임기구다. 호르몬을 지속적으로 방출해 배란을 억제하므로 약 3-5년간 효과가 지속된다."

**해설 작성 필수**
- 정답(또는 오답)이 왜 그런지 명확하게 설명
- 핵심 개념이나 수치를 포함
- 2-4문장으로 작성
- 학습에 도움이 되는 추가 정보 제공

**출력 예시 1 (옳은 것 고르기)**
{{
  "question": "다음 중 콘돔의 사용법으로 올바른 것은?",
  "choices": [
    "성관계 도중 언제든 착용해도 효과는 동일하다.",
    "한 번 사용한 콘돔은 깨끗이 씻으면 재사용할 수 있다.",
    "포장을 뜯을 때 손톱이나 날카로운 도구를 사용하면 빠르고 편리하다.",
    "발기 후 삽입 전에 착용해야 하며, 공기를 빼고 끝 부분에 여유 공간을 둔다. 올바른 사용 시 약 98%의 피임 효과가 있다."
  ],
  "correct_index": 3,
  "explanation": "콘돔은 발기 직후 삽입 전에 착용해야 하며, 끝 부분에 공기가 남지 않도록 주의해야 합니다. 재사용은 절대 금지되며, 손톱이나 날카로운 도구는 제품을 손상시킬 수 있습니다. 올바르게 사용하면 98%의 높은 피임 효과를 보입니다."
}}

**출력 예시 2 (틀린 것 고르기)**
{{
  "question": "다음 중 매독에 대한 설명으로 틀린 것은?",
  "choices": [
    "1기 매독은 통증 없는 궤양(경성하감)이 나타나며 2-3주 후 자연 소실된다.",
    "치료하지 않으면 3기까지 진행되어 심장이나 뇌에 손상을 줄 수 있다.",
    "페니실린 항생제로 치료 가능하며 조기 발견 시 완치율이 높다.",
    "콘돔 사용만으로 100% 예방 가능하므로 다른 예방법은 필요 없다."
  ],
  "correct_index": 3,
  "explanation": "콘돔은 매독 예방에 효과적이지만 100% 예방을 보장하지는 않습니다. 피부 접촉으로도 전염될 수 있으므로 정기적인 검사와 조기 발견이 중요합니다. 1-3기 모두 페니실린으로 치료 가능하지만, 조기 치료가 가장 효과적입니다."
}}

**필수 규칙**
1. [근거 자료]의 내용만 사용
2. 정답은 반드시 {correct_position} 번째 위치에 배치
3. 질문에 {topic}과 {question_type} 형식 반영
4. 각 보기는 완전한 문장으로 작성
5. 정답에는 정의 + 특징 + 수치 포함
6. 해설은 필수이며 교육적이어야 함
7. JSON 형식으로만 출력

JSON만 출력하세요:"""

# 질문 형식 리스트 (개념형)
QUESTION_TYPES = [
    "옳은 것은?",
    "틀린 것은?",
    "적절한 것은?",
    "적절하지 않은 것은?",
    "올바른 것은?",
    "부적절한 것은?"
]


def get_prompt(qtype: str, keyword: str, topic: str, context: str,
               correct_position: int, question_type: str = None) -> str:
    """
    문제 유형에 따라 적절한 프롬프트 반환

    Args:
        qtype: 'situation' 또는 'concept'
        keyword: 키워드
        topic: 주제
        context: RAG 컨텍스트
        correct_position: 정답 위치 (0-3)
        question_type: 질문 형식 (개념형에만 사용)
    """
    if qtype == "situation":
        return SITUATION_PROMPT.format(
            keyword=keyword,
            topic=topic,
            context=context,
            correct_position=correct_position + 1  # 1-indexed for LLM
        )
    else:  # concept
        return CONCEPT_PROMPT.format(
            keyword=keyword,
            topic=topic,
            context=context,
            correct_position=correct_position + 1,  # 1-indexed for LLM
            question_type=question_type or "옳은 것은?"
        )
